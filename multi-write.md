## `[multi-write]` Атомарная запись в `n` ячеек

Рассмотрим операцию `Multi-Write(r1,v1,r2,v2,...,rn,vn)`, которая атомарно записывает значения `v1,v2,...,vn` в ячейки `r1,r2,...,rn` соответственно. 


Покажите, что `Multi-Write` в две ячейки памяти позволяет решить консенсус для двух потоков.
Докажите, что `Multi-Write` в `n` ячеек памяти вместе с обычными точечными чтениями / записями позволяет решить консенсус по крайней мере для `n` потоков.

## Решение:

1) Для двух ячеек, то есть имеем операцию `write(r1, v1, r2, v2)`:
Пусть есть 3 регистра, в которые мы можем писать и в них изначально нули. Потоки `T1` и `T2` делают `write(r1, 1, r3, 1)` и `write(r2, 2, r3, 2)` соответственно. Как определить победителя? Если значение `r1` и `r2` нули, значит никто еще не пришел, если `r1 = 1`, а `r2 = 0` (чтение произведено в том же порядке), то `T1` пришел раньше и он победил. Если нет, прочитаем `r1` снова:
a) Было: `r1 = 0`, `r2 = 2`.
Если после прочтения так и осталось, то `T2` явилс я раньше и победил.
Если нет, и `r1 = 1`, то запись 1 в `r3` произошла позже записи 2, значит также победил второй поток.
b) Было: `r1 = 1, r2 = 2`.
После прочтения `r1` ничего не изменится и победитель определится значением `r3`.

2) Для `n` ячеек, то есть имеем операцию `write(r1, v1, r2, v2,..., rN, vN)`:
Заведем по одному регистру на каждую пару потоков(`r_ij`), а также по регистру для каждого потока(`r_i`). Каждый поток `i` будет писать так: `write(r_i, i, r_{ij_1}, i, ...., r_{ij_{n-1}}, i)`.
То есть он записывает число `i` в свой регистры и все регистры, разделяемые им с другими потоками. Всего запись в `n` регистров.
Далее проводим "турнир": раcматриваем все пары потоков `(i, j)`.
Необходимо посмотреть на регистры `r_i`, `r_j` и `r_ij` и определить победителя по пункту 1 задачи. Так мы выясним поток, который ни разу не проиграл, то есть выиграл в задаче консенсуса.

1) Для начала покажем, что `Multi-Write` в две ячейки памяти позволяет решить консенсус для двух потоков. Для этого рассмотрим 2 какие-либо ячейки памяти. Пусть у нас есть 3 регистра с записанными в ними любыми (!) отрицательными числами. Далее рассмотрим 2 потока:

`первый поток`: `write(r1, 1, r3, 1)`

`второй поток`: `write(r2, 2, r3, 2)`

1. Если в `r1` и `r2` отрицательные числа, значит, ни один поток ещё не дошёл.
2. Если мы считывем в `r1 = 1`, а в `r2` любое отрицательное число, то первый поток пришел раньше.
3. Если условия двух первых пунктов не выполнены, то прочитаем ещё раз в том же порядке две ячейки.

3.1. Если было: в `r1` любое отрицательное число, `r2 = 2`. 

стало: `r1 = 0`, `r2 = 2`,
          
то второй поток пришёл раньше.

3.2. Если было: `r1 = 1, r2 = 2` => определим пришедший раньше поток по `r3`.

2) Теперь докажем, что `Multi-Write` в `n` ячеек памяти вместе с обычными точечными чтениями / записями позволяет решить консенсус по крайней мере для `n` потоков. Для этого нужно завести регистры для каждой пары потоков + по отдельному регистру на каждый поток.
Тогда запись `i-ого` потока будет выглядеть так: `i` записывается в `ri` и во все парные регистры, создающие пару с данным номером потока. Далее проводим "турнир": раcматриваем все пары потоков. Каждый раз смотрим на отдельные регистры для двух потоков, образующих пару + их совместый регистр. Действуем аналогично первому пункту данной задачи. Так мы сможем найти поток, который победит в задаче консенсуса.

ч.т.д.

